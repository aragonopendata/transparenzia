require 'nokogiri'
require 'open-uri'
require 'csv'

HUESCA_MUNICIPALITIES = ['Abiego','Abizanda','Adahuesca','Agüero','Aínsa-Sobrarbe','Aisa','Albalate de Cinca','Albalatillo','Albelda','Albero Alto','Albero Bajo','Alberuela de Tubo','Alcalá de Gurrea','Alcalá del Obispo','Alcampell','Alcolea de Cinca','Alcubierre','Alerre','Alfántega','Almudévar','Almunia de San Juan','Almuniente','Alquézar','Altorricón','Angüés','Ansó','Antillón','Aragüés del Puerto','Arén','Argavieso','Arguis','Ayerbe','Azanuy-Alins','Azara','Azlor','Baélls','Bailo','Baldellou','Ballobar','Banastás','Barbastro','Barbués','Barbuñales','Bárcabo','Belver de Cinca','Benabarre','Benasque','Berbegal','Bielsa','Bierge','Biescas','Binaced','Binéfar','Bisaurri','Biscarrués','Blecua y Torres','Boltaña','Bonansa','Borau','Broto','Caldearenas','Campo','Camporrélls','Canal de Berdún','Candasnos','Canfranc','Capdesaso','Capella','Casbas de Huesca','Castejón de Monegros','Castejón de Sos','Castejón del Puente','Castelflorite','Castiello de Jaca','Castigaleu','Castillazuelo','Castillonroy','Chalamera','Chía','Chimillas','Colungo','Esplús','Estada','Estadilla','Estopiñán del Castillo','Fago','Fanlo','Fiscal','Fonz','Foradada del Toscar','Fraga','La Fueva','Gistaín','El Grado','Grañén','Graus','Gurrea de Gállego','Hoz de Jaca','Hoz y Costean','Huerto','Huesca','Ibieca','Igriés','Ilche','Isábena','Jaca','Jasa','Labuerda','Laluenga','Lalueza','Lanaja','Laperdiguera','Lascellas-Ponzano','Lascuarre','Laspaúles','Laspuña','Loarre','Loporzano','Loscorrales','Lupiñén-Ortilla','Monesma y Cajigar','Monflorite-Lascasas','Montanuy','Monzón','Naval','Novales','Nueno','Olvena','Ontiñena','Osso de Cinca','Palo','Panticosa','Peñalba','Las Peñas de Riglos','Peralta de Alcofea','Peralta de Calasanz','Peraltilla','Perarrúa','Pertusa','Piracés','Plan','Poleñino','Pozán de Vero','La Puebla de Castro','Puente de Montañana','Puente la Reina de Jaca','Puértolas','El Pueyo de Araguás','Pueyo de Santa Cruz','Quicena','Robres','Sabiñánigo','Sahún','Salas Altas','Salas Bajas','Salillas','Sallent de Gállego','San Esteban de Litera','San Juan de Plan','San Miguel del Cinca','Sangarrén','Santa Cilia','Santa Cruz de la Serós','Santa María de Dulcis','Santaliestra y San Quílez','Sariñena','Secastilla','Seira','Sena','Senés de Alcubierre','Sesa','Sesué','Siétamo','Sopeira','La Sotonera','Tamarite de Litera','Tardienta','Tella-Sin','Tierz','Tolva','Torla','Torralba de Aragón','Torre la Ribera','Torrente de Cinca','Torres de Alcanadre','Torres de Barbués','Tramaced','Valfarta','Valle de Bardají','Valle de Hecho','Valle de Lierp','Velilla de Cinca','Vencillón','Veracruz','Viacamp y Litera','Vicién','Villanova','Villanúa','Villanueva de Sigena','Yebra de Basa','Yésero','Zaidín']
ZARAGOZA_MUNICIPALITIES = ['Abanto','Acered','Agón','Aguarón','Aguilón','Ainzón','Aladrén','Alagón','Alarba','Alberite de San Juan','Albeta','Alborge','Alcalá de Ebro','Alcalá de Moncayo','Alconchel de Ariza','Aldehuela de Liestos','Alfajarín','Alfamén','Alforque','Alhama de Aragón','Almochuel','La Almolda','Almonacid de la Cuba','Almonacid de la Sierra','La Almunia de Doña Godina','Alpartir','Ambel','Anento','Aniñón','Añón de Moncayo','Aranda de Moncayo','Arándiga','Ardisa','Ariza','Artieda','Asín','Atea','Ateca','Azuara','Badules','Bagüés','Balconchán','Bárboles','Bardallur','Belchite','Belmonte de Gracián','Berdejo','Berrueco','Biel','Bijuesca','Biota','Bisimbre','Boquiñeni','Bordalba','Borja','Botorrita','Brea de Aragón','Bubierca','Bujaraloz','Bulbuente','Bureta','El Burgo de Ebro','El Buste','Cabañas de Ebro','Cabolafuente','Cadrete','Calatayud','Calatorao','Calcena','Calmarza','Campillo de Aragón','Carenas','Cariñena','Caspe','Castejón de Alarba','Castejón de las Armas','Castejón de Valdejasa','Castiliscar','Cervera de la Cañada','Cerveruela','Cetina','Chiprana','Chodes','Cimballa','Cinco Olivas','Clarés de Ribota','Codo','Codos','Contamina','Cosuenda','Cuarte de Huerva','Cubel','Las Cuerlas','Daroca','Ejea de los Caballeros','Embid de Ariza','Encinacorba','Épila','Erla','Escatrón','Fabara','Farlete','Fayón','Los Fayos','Figueruelas','Fombuena','El Frago','El Frasno','Fréscano','Fuendejalón','Fuendetodos','Fuentes de Ebro','Fuentes de Jiloca','Gallocanta','Gallur','Gelsa','Godojos','Gotor','Grisel','Grisén','Herrera de los Navarros','Ibdes','Illueca','Isuerre','Jaraba','Jarque','Jaulín','La Joyosa','Lagata','Langa del Castillo','Layana','Lécera','Lechón','Leciñena','Letux','Litago','Lituénigo','Lobera de Onsella','Longares','Longás','Lucena de Jalón','Luceni','Luesia','Luesma','Lumpiaque','Luna','Maella','Magallón','Mainar','Malanquilla','Maleján','Mallén','Malón','Maluenda','Manchones','Mara','María de Huerva','Marracos','Mediana de Aragón','Mequinenza','Mesones de Isuela','Mezalocha','Mianos','Miedes de Aragón','Monegrillo','Moneva','Monreal de Ariza','Monterde','Montón','Morata de Jalón','Morata de Jiloca','Morés','Moros','Moyuela','Mozota','Muel','La Muela','Munébrega','Murero','Murillo de Gállego','Navardún','Nigüella','Nombrevilla','Nonaspe','Novallas','Novillas','Nuévalos','Nuez de Ebro','Olvés','Orcajo','Orera','Orés','Oseja','Osera de Ebro','Paniza','Paracuellos de Jiloca','Paracuellos de la Ribera','Pastriz','Pedrola','Las Pedrosas','Perdiguera','Piedratajada','Pina de Ebro','Pinseque','Los Pintanos','Plasencia de Jalón','Pleitas','Plenas','Pomer','Pozuel de Ariza','Pozuelo de Aragón','Pradilla de Ebro','Puebla de Albortón','La Puebla de Alfindén','Puendeluna','Purujosa','Quinto','Remolinos','Retascón','Ricla','Romanos','Rueda de Jalón','Ruesca','Sabiñán','Sádaba','Salillas de Jalón','Salvatierra de Esca','Samper del Salz','San Martín de la Virgen de Moncayo','San Mateo de Gállego','Santa Cruz de Grío','Santa Cruz de Moncayo','Santa Eulalia de Gállego','Santed','Sástago','Sediles','Sestrica','Sierra de Luna','Sigüés','Sisamón','Sobradiel','Sos del Rey Católico','Tabuenca','Talamantes','Tarazona','Tauste','Terrer','Tierga','Tobed','Torralba de los Frailes','Torralba de Ribota','Torralbilla','Torrehermosa','Torrelapaja','Torrellas','Torres de Berrellén','Torrijo de la Cañada','Tosos','Trasmoz','Trasobares','Uncastillo','Undués de Lerda','Urrea de Jalón','Urriés','Used','Utebo','Val de San Martín','Valdehorna','Valmadrid','Valpalmas','Valtorres','Velilla de Ebro','Velilla de Jiloca','Vera de Moncayo','Vierlas','Villadoz','Villafeliche','Villafranca de Ebro','Villalba de Perejil','Villalengua','Villamayor de Gállego','Villanueva de Gállego','Villanueva de Huerva','Villanueva de Jiloca','Villar de los Navarros','Villarreal de Huerva','Villarroya de la Sierra','Villarroya del Campo','La Vilueña','Vistabella','La Zaida','Zaragoza','Zuera']
TERUEL_MUNICIPALITIES = ['Ababuj','Abejuela','Aguatón','Aguaviva','Aguilar del Alfambra','Alacón','Alba','Albalate del Arzobispo','Albarracín','Albentosa','Alcaine','Alcalá de la Selva','Alcañiz','Alcorisa','Alfambra','Aliaga','Allepuz','Alloza','Allueva','Almohaja','Alobras','Alpeñés','Anadón','Andorra','Arcos de las Salinas','Arens de Lledó','Argente','Ariño','Azaila','Bádenas','Báguena','Bañón','Barrachina','Bea','Beceite','Bello','Belmonte de San José','Berge','Bezas','Blancas','Blesa','Bordón','Bronchales','Bueña','Burbáguena','Cabra de Mora','Calaceite','Calamocha','Calanda','Calomarde','Camañas','Camarena de la Sierra','Camarillas','Caminreal','Cantavieja','Cañada de Benatanduz','La Cañada de Verich','Cañada Vellida','Cañizar del Olivar','Cascante del Río','Castejón de Tornos','Castel de Cabra','El Castellar','Castellote','Castelnou','Castelserás','Cedrillas','Celadas','Cella','La Cerollera','La Codoñera','Corbalán','Cortes de Aragón','Cosa','Cretas','Crivillén','La Cuba','Cubla','Cucalón','El Cuervo','Cuevas de Almudén','Cuevas Labradas','Ejulve','Escorihuela','Escucha','Estercuel','Ferreruela de Huerva','Fonfría','Formiche Alto','Fórnoles','Fortanete','Foz-Calanda','La Fresneda','Frías de Albarracín','Fuenferrada','Fuentes Calientes','Fuentes Claras','Fuentes de Rubielos','Fuentespalda','Galve','Gargallo','Gea de Albarracín','La Ginebrosa','Griegos','Guadalaviar','Gúdar','Híjar','Hinojosa de Jarque','La Hoz de la Vieja','Huesa del Común','La Iglesuela del Cid','Jabaloyas','Jarque de la Val','Jatiel','Jorcas','Josa','Lagueruela','Lanzuela','Libros','Lidón','Linares de Mora','Lledó','Loscos','Maicas','Manzanera','Martín del Río','Mas de las Matas','La Mata de los Olmos','Mazaleón','Mezquita de Jarque','Mirambel','Miravete de la Sierra','Molinos','Monforte de Moyuela','Monreal del Campo','Monroyo','Montalbán','Monteagudo del Castillo','Monterde de Albarracín','Mora de Rubielos','Moscardón','Mosqueruela','Muniesa','Noguera de Albarracín','Nogueras','Nogueruelas','Obón','Odón','Ojos Negros','Olba','Oliete','Los Olmos','Orihuela del Tremedal','Orrios','Palomar de Arroyos','Pancrudo','Las Parras de Castellote','Peñarroya de Tastavins','Peracense','Peralejos','Perales del Alfambra','Pitarque','Plou','El Pobo','La Portellada','Pozondón','Pozuel del Campo','La Puebla de Híjar','La Puebla de Valverde','Puertomingalvo','Ráfales','Rillo','Riodeva','Ródenas','Royuela','Rubiales','Rubielos de la Cérida','Rubielos de Mora','Salcedillo','Saldón','Samper de Calanda','San Agustín','San Martín del Río','Santa Cruz de Nogueras','Santa Eulalia','Sarrión','Segura de los Baños','Seno','Singra','Terriente','Teruel','Toril y Masegoso','Tormón','Tornos','Torralba de los Sisones','Torre de Arcas','Torre de las Arcas','Torre del Compte','Torre los Negros','Torrecilla de Alcañiz','Torrecilla del Rebollar','Torrelacárcel','Torremocha de Jiloca','Torres de Albarracín','Torrevelilla','Torrijas','Torrijo del Campo','Tramacastiel','Tramacastilla','Tronchón','Urrea de Gaén','Utrillas','Valacloche','Valbona','Valdealgorfa','Valdecuenca','Valdelinares','Valdeltormo','Valderrobres','Valjunquera','El Vallecillo','Veguillas de la Sierra','Villafranca del Campo','Villahermosa del Campo','Villanueva del Rebollar de la Sierra','Villar del Cobo','Villar del Salz','Villarluengo','Villarquemado','Villarroya de los Pinares','Villastar','Villel','Vinaceite','Visiedo','Vivel del Río Martín','La Zoma']

def generate_municipalities_data(url, district, municipalities)
  doc = Nokogiri::HTML(open(url))
  doc.css(".concejos a").each do |link|
    municipality = link.content
    if municipality.include?("(")
      start = municipality.index("(")
      stop = municipality.index(")") - start
      article = municipality[start+1, stop-1]
      municipality = article + " " + municipality[0, start]
    end
    municipality.strip!
    if HUESCA_MUNICIPALITIES.include?(municipality)
      province = "Huesca"
    elsif ZARAGOZA_MUNICIPALITIES.include?(municipality)
      province = "Zaragoza"
    elsif TERUEL_MUNICIPALITIES.include?(municipality)
      province = "Teruel"
    end
    
    begin
      municipalities << [municipality , district , province]
    rescue  
      municipalities << [municipality , district , "Sin provincia"]
    end
  end
end

urls = ["http://www.pueblosdearagon.es/provincia/huesca", "http://www.pueblosdearagon.es/provincia/zaragoza", "http://www.pueblosdearagon.es/provincia/teruel"]
data = []
urls.each do |url|
  doc = Nokogiri::HTML(open(url))
  doc.css(".concejos a").each do |link|
    generate_municipalities_data("http://www.pueblosdearagon.es"+link['href'], link.content, data)
  end
end

CSV.open("municipalities.csv", "wb") do |csv|
  csv << ["name", "district", "province"]
  data.each{|line| csv << line}
end